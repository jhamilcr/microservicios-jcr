services:
  mongo:
    image: mongo:7
    container_name: ms_mongo
    restart: always
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS}
      MONGO_INITDB_DATABASE: ${MONGO_DB}
    ports:
      - "27018:27017"   # host:container (c√°mbialo si quieres)
    volumes:
      - mongo_data:/data/db
      - ./db/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    healthcheck:
      test: ["CMD-SHELL", "mongosh --username ${MONGO_USER} --password ${MONGO_PASS} --authenticationDatabase admin --eval 'db.runCommand({ping:1})' ${MONGO_DB} --quiet"]
      interval: 5s
      timeout: 3s
      retries: 15

  app:
    build: ./app
    container_name: ms_app
    depends_on:
      mongo:
        condition: service_healthy
    environment:
      MONGO_HOST: ${MONGO_HOST}
      MONGO_PORT: ${MONGO_PORT}
      MONGO_DB: ${MONGO_DB}
      MONGO_USER: ${MONGO_USER}
      MONGO_PASS: ${MONGO_PASS}
      NODE_ENV: ${NODE_ENV}
      APP_PORT: ${APP_PORT}
    ports:
      - "${APP_PORT}:${APP_PORT}"
    command: ["npm", "run", "dev"]
    volumes:
      - ./app/src:/usr/src/app/src
      - ./app/package.json:/usr/src/app/package.json

  mongo-express:
    image: mongo-express:1.0.2-20
    container_name: ms_mongo_express
    restart: always
    ports:
      - "8082:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: ${MONGO_USER}
      ME_CONFIG_MONGODB_ADMINPASSWORD: ${MONGO_PASS}
      ME_CONFIG_MONGODB_SERVER: mongo
      ME_CONFIG_BASICAUTH: "false"

volumes:
  mongo_data: